<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Your Purchase - Empath</title>

  <!-- FastSpring Embedded Checkout Script -->
  <script
    id="fsc-api"
    src="https://sbl.onfastspring.com/sbl/1.0.5/fastspring-builder.min.js"
    type="text/javascript"
    data-storefront="empath.onfastspring.com/embedded-checkout">
  </script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen';
      background: white;
      margin: 0;
      padding: 24px;
      min-height: 100vh;
    }

    .logo-container {
      text-align: center;
      margin-top: 30px;
      margin-bottom: 60px;
    }

    .logo-link {
      display: inline-block;
    }

    .logo {
      height: 60px;
      width: auto;
      filter: drop-shadow(0px 4px 4px rgba(0, 0, 0, 0.10));
      opacity: 0.9;
    }

    .main-container {
      display: flex;
      gap: 100px;
      max-width: 1200px;
      margin: 0 auto;
      align-items: flex-start;
    }

    .left-content {
      flex: 0 0 400px;
      padding: 160px 0px;
    }

    h2 {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;  
      margin: 0 0 24px 0;
      color: #1a1a1a;
      font-size: 45px;
      font-weight: 900;
      letter-spacing: -0.1rem;
      text-align: center;
      line-height: 40px;
    }

    .plan-toggle {
      display: flex;
      background: #f8f9fa;
      border-radius: 50px;
      padding: 4px;
      margin-bottom: 32px;
      border: 1px solid #e9ecef;
    }

    .plan-button {
      flex: 1;
      padding: 12px 24px;
      border: none;
      background: transparent;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #6c757d;
      text-align: center;
    }

    .plan-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }

    .plan-button:not(.active):hover {
      color: #495057;
      background: rgba(102, 126, 234, 0.1);
    }

    .plan-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .plan-details {
      text-align: center;
      margin-bottom: 24px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      min-height: 70px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .plan-name {
      font-weight: 600;
      color: #495057;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .plan-price {
      color: #667eea;
      font-size: 18px;
      font-weight: 700;
    }

    .plan-savings {
      color: #16a34a;
      font-size: 12px;
      font-weight: 500;
      margin-top: 4px;
    }

    .back-link {
      text-align: center;
      margin-top: 16px;
      display: none;
    }

    .checkout-wrapper {
      flex: 1;
      background: white;
      border-radius: 20px;
      border: 1px solid #e1e5e9;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      min-height: 600px;
      padding: 30px;
      position: relative;
      overflow: hidden;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 10;
    }

    .loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #667eea;
      font-size: 14px;
      font-weight: 500;
    }

    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 16px;
      text-align: center;
    }

    .success-message {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 16px;
      text-align: center;
    }

    /* Responsive design */
    @media (max-width: 1024px) {
      .main-container {
        flex-direction: column;
        gap: 24px;
      }
      
      .left-content {
        flex: none;
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .left-content, .checkout-wrapper {
        margin: 0 12px;
        padding: 24px 20px;
        max-width: none;
      }
      
      h2 {
        font-size: 20px;
      }
      
      .plan-button {
        padding: 10px 16px;
        font-size: 13px;
      }
      
      .logo {
        height: 48px;
      }
    }
  </style>
</head>
<body>
  <div class="logo-container">
    <a href="https://www.get-empath.com" class="logo-link">
      <img src="https://images.squarespace-cdn.com/content/v1/67b5499db71bd36240b6d2d7/994c48e7-65c4-47cc-b846-d47db72c04b9/EmpathLogo.png?format=1500w" alt="Empath" class="logo">
    </a>
  </div>

  <div class="main-container">
    <div class="left-content">
      <h2>Complete Your Purchase</h2>

      <div id="error-container"></div>

      <div class="plan-toggle">
        <button class="plan-button active" data-plan="monthly" onclick="switchToMonthly()" id="monthly-btn">
          Monthly Plan
        </button>
        <button class="plan-button" data-plan="annual" onclick="switchToAnnual()" id="annual-btn">
          Annual Plan
        </button>
      </div>

      <div class="plan-details" id="plan-details">
        <div class="plan-name" id="plan-name">Pro Monthly</div>
        <div class="plan-price" id="plan-price">$8.99/month</div>
        <div class="plan-savings" id="plan-savings" style="display: none;"></div>
      </div>

      <div class="back-link">
        <a href="/signup">‚Üê Back to signup</a>
      </div>
    </div>

    <div class="checkout-wrapper">
      <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Switching plans...</div>
      </div>

      <!-- FastSpring embedded checkout container -->
      <div id="fsc-embedded-checkout-container"></div>
    </div>
  </div>

  <script>
    let currentPlan = 'monthly';
    let isInitialized = false;
    let userInfo = {};

    const planConfig = {
      monthly: {
        name: 'Pro Monthly',
        price: '$8.99/month',
        savings: null,
        productId: 'empath-monthly'
      },
      annual: {
        name: 'Pro Annual',
        price: '$89.99/year',
        savings: 'Save 17% compared to monthly',
        productId: 'empath-annual'
      }
    };

    // Get user info from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    userInfo = {
      email: urlParams.get('email'),
      userId: urlParams.get('userId'),
      displayName: urlParams.get('displayName')
    };

    function showError(message) {
      const container = document.getElementById('error-container');
      container.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function showSuccess(message) {
      const container = document.getElementById('error-container');
      container.innerHTML = `<div class="success-message">${message}</div>`;
    }

    function clearMessages() {
      document.getElementById('error-container').innerHTML = '';
    }

    function showLoading(text = 'Switching plans...') {
      const overlay = document.getElementById('loading-overlay');
      const loadingText = document.getElementById('loading-text');
      loadingText.textContent = text;
      overlay.classList.add('show');
      
      // Disable plan buttons during loading
      document.getElementById('monthly-btn').disabled = true;
      document.getElementById('annual-btn').disabled = true;
    }

    function hideLoading() {
      const overlay = document.getElementById('loading-overlay');
      overlay.classList.remove('show');
      
      // Re-enable plan buttons
      document.getElementById('monthly-btn').disabled = false;
      document.getElementById('annual-btn').disabled = false;
    }

    function updatePlanDetails(plan) {
      const config = planConfig[plan];
      document.getElementById('plan-name').textContent = config.name;
      document.getElementById('plan-price').textContent = config.price;
      
      const savingsEl = document.getElementById('plan-savings');
      if (config.savings) {
        savingsEl.textContent = config.savings;
        savingsEl.style.display = 'block';
      } else {
        savingsEl.style.display = 'none';
      }
    }

    function updateButtonStates() {
      document.querySelectorAll('.plan-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.plan === currentPlan);
      });
    }

    function initializeCheckout(plan = 'monthly') {
      if (typeof fastspring === 'undefined' || !fastspring.builder) {
        showError('Payment system not available. Please refresh the page.');
        return;
      }

      showLoading('Loading checkout...');
      clearMessages();

      try {
        const config = planConfig[plan];
        
        fastspring.builder.push({
          products: [{
            path: config.productId,
            quantity: 1
          }],
          paymentRequestId: 'checkout-init-' + Date.now(),
          paymentContact: {
            email: userInfo.email || '',
            firstName: userInfo.displayName ? userInfo.displayName.split(' ')[0] : '',
            lastName: userInfo.displayName ? userInfo.displayName.split(' ').slice(1).join(' ') : ''
          }
        });

        // Set user recognition if available
        if (userInfo.email) {
          setTimeout(() => {
            try {
              fastspring.builder.recognize({
                email: userInfo.email,
                tags: {
                  userId: userInfo.userId,
                  displayName: userInfo.displayName,
                  plan: plan,
                  source: 'web_checkout'
                }
              });
            } catch (error) {
              console.log('User recognition error:', error);
            }
          }, 1000);
        }

        isInitialized = true;
        currentPlan = plan;
        updatePlanDetails(plan);
        updateButtonStates();
        
        // Hide loading after FastSpring loads
        setTimeout(() => {
          hideLoading();
        }, 3000);

      } catch (error) {
        hideLoading();
        showError('Failed to load checkout. Please try again.');
        console.error('Checkout initialization error:', error);
      }
    }

    function switchToMonthly() {
      if (currentPlan === 'monthly' || document.getElementById('monthly-btn').disabled) return;
      
      clearMessages();
      showLoading('Switching to monthly plan...');

      if (!isInitialized) {
        initializeCheckout('monthly');
        return;
      }

      try {
        // Reset cart
        fastspring.builder.reset();
        
        // Wait then add monthly product
        setTimeout(() => {
          try {
            fastspring.builder.push({
              products: [{
                path: planConfig.monthly.productId,
                quantity: 1
              }],
              paymentRequestId: 'switch-monthly-' + Date.now(),
              paymentContact: {
                email: userInfo.email || '',
                firstName: userInfo.displayName ? userInfo.displayName.split(' ')[0] : '',
                lastName: userInfo.displayName ? userInfo.displayName.split(' ').slice(1).join(' ') : ''
              }
            });

            currentPlan = 'monthly';
            updatePlanDetails('monthly');
            updateButtonStates();
            
            setTimeout(() => {
              hideLoading();
            }, 2000);

          } catch (error) {
            hideLoading();
            showError('Failed to switch to monthly plan. Please try again.');
          }
        }, 1000);

      } catch (error) {
        hideLoading();
        showError('Failed to switch plans. Please refresh the page.');
      }
    }

    function switchToAnnual() {
      if (currentPlan === 'annual' || document.getElementById('annual-btn').disabled) return;
      
      clearMessages();
      showLoading('Switching to annual plan...');

      if (!isInitialized) {
        initializeCheckout('annual');
        return;
      }

      try {
        // Reset cart
        fastspring.builder.reset();
        
        // Wait then add annual product
        setTimeout(() => {
          try {
            fastspring.builder.push({
              products: [{
                path: planConfig.annual.productId,
                quantity: 1
              }],
              paymentRequestId: 'switch-annual-' + Date.now(),
              paymentContact: {
                email: userInfo.email || '',
                firstName: userInfo.displayName ? userInfo.displayName.split(' ')[0] : '',
                lastName: userInfo.displayName ? userInfo.displayName.split(' ').slice(1).join(' ') : ''
              }
            });

            currentPlan = 'annual';
            updatePlanDetails('annual');
            updateButtonStates();
            
            setTimeout(() => {
              hideLoading();
            }, 2000);

          } catch (error) {
            hideLoading();
            showError('Failed to switch to annual plan. Please try again.');
          }
        }, 1000);

      } catch (error) {
        hideLoading();
        showError('Failed to switch plans. Please refresh the page.');
      }
    }

    // Listen for FastSpring events
    window.addEventListener('message', function(event) {
      if (event.origin.includes('fastspring') || event.origin.includes('onfastspring')) {
        const data = event.data;
        
        if (data.fscPopupMessage) {
          const msg = data.fscPopupMessage;
          
          if (msg.action === 'event' && msg.eventData) {
            // Handle checkout events
            if (msg.eventData.event === 'FSC-checkoutComplete') {
              console.log('Checkout completed, redirecting to download page...');
              showSuccess('Purchase completed successfully! Redirecting...');
              
              // Try multiple redirect methods for better browser compatibility
              setTimeout(() => {
                try {
                  // Primary redirect method
                  window.location.href = 'https://www.get-empath.com/download';
                } catch (error) {
                  console.error('Primary redirect failed:', error);
                  // Fallback redirect method
                  try {
                    window.location.replace('https://www.get-empath.com/download');
                  } catch (fallbackError) {
                    console.error('Fallback redirect failed:', fallbackError);
                    // Final fallback - open in new window
                    window.open('https://www.get-empath.com/download', '_top');
                  }
                }
              }, 2000);
            }
          }
          
          // Hide loading when checkout loads
          if (msg.action === 'resizeInlineContainer') {
            setTimeout(() => {
              hideLoading();
            }, 500);
          }
        }
      }
    });

    // Initialize checkout when page loads
    window.addEventListener('load', function() {
      setTimeout(() => {
        if (typeof fastspring !== 'undefined' && fastspring.builder) {
          // Check if user specified a plan in URL
          const urlPlan = urlParams.get('plan');
          const initialPlan = (urlPlan && planConfig[urlPlan]) ? urlPlan : 'monthly';
          
          initializeCheckout(initialPlan);
        } else {
          showError('Payment system failed to load. Please refresh the page.');
        }
      }, 2000);
    });

    // Handle page visibility for better UX
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        // Hide loading overlay if page becomes visible and it's been showing for too long
        setTimeout(() => {
          if (document.getElementById('loading-overlay').classList.contains('show')) {
            hideLoading();
          }
        }, 5000);
      }
    });
  </script>
</body>
</html>