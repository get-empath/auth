<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test 2 - Embedded Checkout</title>
  
  <!-- FastSpring Embedded Script -->
  <script
    id="fsc-api"
    src="https://sbl.onfastspring.com/sbl/1.0.5/fastspring-builder.min.js"
    type="text/javascript"
    data-storefront="empath.onfastspring.com/embedded-empath-monthly">
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .test-button {
      background: #28a745;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
    }
    
    .test-button:hover {
      background: #218838;
    }
    
    .log-container {
      background: #f5f5f5;
      border: 1px solid #ddd;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .log-entry {
      margin: 5px 0;
      font-family: monospace;
      font-size: 12px;
    }
    
    .log-success { color: #28a745; }
    .log-error { color: #dc3545; }
    .log-info { color: #007bff; }
    .log-warning { color: #ffc107; }
    
    .checkout-container {
      border: 2px dashed #ddd;
      min-height: 400px;
      padding: 20px;
      margin: 20px 0;
      border-radius: 4px;
      background: #fafafa;
    }
    
    .container-status {
      text-align: center;
      color: #666;
      font-style: italic;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>Test 2: FastSpring Embedded Checkout</h1>
  <p><strong>Testing:</strong> empath.onfastspring.com/embedded-empath-monthly</p>

  <button class="test-button" onclick="testFastSpringAPI()">
    Test FastSpring API
  </button>

  <button class="test-button" onclick="inspectContainer()">
    Inspect Container
  </button>

  <button class="test-button" onclick="clearLogs()">
    Clear Logs
  </button>

  <div class="log-container" id="log-container">
    <div class="log-entry log-info">Test started - waiting for FastSpring to load...</div>
  </div>

  <h3>Embedded Checkout Container:</h3>
  <div class="checkout-container">
    <div class="container-status" id="container-status">
      Waiting for FastSpring to initialize...
    </div>
    
    <!-- FastSpring embedded checkout container -->
    <div id="fsc-embedded-checkout-container"></div>
  </div>

  <script>
    let logCount = 0;

    function log(message, type = 'info') {
      logCount++;
      const timestamp = new Date().toLocaleTimeString();
      const logContainer = document.getElementById('log-container');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      logEntry.innerHTML = `[${timestamp}] ${message}`;
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
      
      // Also log to console
      console.log(`[FastSpring Test] ${message}`);
    }

    function clearLogs() {
      document.getElementById('log-container').innerHTML = '';
      logCount = 0;
    }

    function inspectContainer() {
      log('Inspecting embedded checkout container...', 'info');
      
      const container = document.getElementById('fsc-embedded-checkout-container');
      if (container) {
        log('âœ… Container element found', 'success');
        log(`   Container ID: ${container.id}`, 'info');
        log(`   Container innerHTML length: ${container.innerHTML.length}`, 'info');
        log(`   Container children count: ${container.children.length}`, 'info');
        
        if (container.innerHTML.trim() === '') {
          log('âš ï¸ Container is empty', 'warning');
          document.getElementById('container-status').textContent = 'Container is empty - FastSpring not loaded';
        } else {
          log('âœ… Container has content', 'success');
          log(`   First 100 chars: ${container.innerHTML.substring(0, 100)}`, 'info');
          document.getElementById('container-status').textContent = 'Container has content';
        }
        
        // Check for iframes (FastSpring typically uses iframes)
        const iframes = container.querySelectorAll('iframe');
        log(`   iframes found: ${iframes.length}`, 'info');
        
        iframes.forEach((iframe, index) => {
          log(`   iframe ${index + 1}: ${iframe.src}`, 'info');
        });
        
      } else {
        log('âŒ Container element not found!', 'error');
      }
    }

    function testFastSpringAPI() {
      log('Testing FastSpring API availability...', 'info');
      
      // Test if FastSpring object exists
      if (typeof fastspring === 'undefined') {
        log('âŒ FastSpring object is undefined', 'error');
        document.getElementById('container-status').textContent = 'FastSpring object not found';
      } else {
        log('âœ… FastSpring object found', 'success');
        
        if (fastspring.builder) {
          log('âœ… FastSpring builder available', 'success');
          
          // Test builder methods
          const builderMethods = ['push', 'recognize', 'contact', 'reset', 'reload'];
          builderMethods.forEach(method => {
            if (typeof fastspring.builder[method] === 'function') {
              log(`âœ… FastSpring.builder.${method}() available`, 'success');
            } else {
              log(`âŒ FastSpring.builder.${method}() not available`, 'error');
            }
          });
        } else {
          log('âŒ FastSpring builder not available', 'error');
        }
      }

      // Test script element
      const scriptEl = document.getElementById('fsc-api');
      if (scriptEl) {
        log('âœ… FastSpring script element found', 'success');
        log(`   Storefront: ${scriptEl.getAttribute('data-storefront')}`, 'info');
        log(`   Script src: ${scriptEl.src}`, 'info');
      } else {
        log('âŒ FastSpring script element not found', 'error');
      }
      
      // Inspect container after API test
      setTimeout(() => {
        inspectContainer();
      }, 1000);
    }

    // Listen for FastSpring script load
    const scriptEl = document.getElementById('fsc-api');
    if (scriptEl) {
      scriptEl.onload = function() {
        log('âœ… FastSpring script loaded successfully', 'success');
        document.getElementById('container-status').textContent = 'FastSpring script loaded - initializing...';
        
        setTimeout(() => {
          testFastSpringAPI();
        }, 1000);
        
        // Check container periodically
        const checkInterval = setInterval(() => {
          const container = document.getElementById('fsc-embedded-checkout-container');
          if (container && container.innerHTML.trim() !== '') {
            log('âœ… Embedded checkout content detected!', 'success');
            document.getElementById('container-status').textContent = 'Embedded checkout loaded successfully!';
            clearInterval(checkInterval);
          }
        }, 1000);
        
        // Stop checking after 30 seconds
        setTimeout(() => {
          clearInterval(checkInterval);
          if (document.getElementById('fsc-embedded-checkout-container').innerHTML.trim() === '') {
            log('âš ï¸ Embedded checkout did not load after 30 seconds', 'warning');
            document.getElementById('container-status').textContent = 'Embedded checkout failed to load';
          }
        }, 30000);
      };
      
      scriptEl.onerror = function() {
        log('âŒ FastSpring script failed to load', 'error');
        document.getElementById('container-status').textContent = 'FastSpring script failed to load';
      };
    }

    // Listen for FastSpring events
    window.addEventListener('message', function(event) {
      if (event.origin.includes('fastspring') || event.origin.includes('onfastspring')) {
        log(`FastSpring event: ${JSON.stringify(event.data)}`, 'success');
        
        if (event.data.type === 'checkout.loaded') {
          log('âœ… FastSpring checkout loaded successfully', 'success');
          document.getElementById('container-status').textContent = 'Checkout loaded successfully!';
        } else if (event.data.type === 'order.completed') {
          log('ðŸŽ‰ Order completed successfully!', 'success');
        }
      }
    });

    // Monitor DOM changes to the container
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.target.id === 'fsc-embedded-checkout-container') {
          log('ðŸ”„ Container content changed', 'info');
          inspectContainer();
        }
      });
    });

    // Start observing
    const container = document.getElementById('fsc-embedded-checkout-container');
    if (container) {
      observer.observe(container, {
        childList: true,
        subtree: true,
        characterData: true
      });
    }

    // Page load test
    window.addEventListener('load', function() {
      log('Page loaded - testing FastSpring in 2 seconds...', 'info');
      setTimeout(() => {
        testFastSpringAPI();
      }, 2000);
    });

    // Initial log
    log('FastSpring Embedded Test initialized', 'info');
  </script>
</body>
</html>