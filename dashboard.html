<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Empath</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen';
      background: #f8f9fa;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    .header {
      background: #f8f9fa;
      padding: 30px 0 20px 0;
      position: relative;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .logo {
      height: 50px;
      width: auto;
    }

    .sign-out-btn {
      position: absolute;
      right: 24px;
      padding: 10px 20px;
      border: 1px solid #e9ecef;
      border-radius: 30px;
      background: white;
      color: #6c757d;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sign-out-btn:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    .welcome-section {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      color: #1a1a1a;
      font-size: 32px;
      font-weight: 900;
      letter-spacing: -0.05rem;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
    }

    .card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e1e5e9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 32px;
    }

    .card h2 {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0 0 16px 0;
      color: #1a1a1a;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02rem;
    }

    .card p {
      color: #6c757d;
      margin: 0 0 16px 0;
      line-height: 1.5;
    }

    .subscription-status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .status-free {
      background: #e9ecef;
      color: #495057;
    }

    .status-active {
      background: #d1e7dd;
      color: #0f5132;
    }

    .status-pending {
      background: #fff3cd;
      color: #664d03;
    }

    .status-canceled {
      background: #f8d7da;
      color: #721c24;
    }

    .status-offline {
      background: #f1f3f4;
      color: #5f6368;
    }

    .plan-info {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .plan-name {
      font-weight: 600;
      color: #495057;
      margin-bottom: 4px;
    }

    .plan-details {
      font-size: 14px;
      color: #6c757d;
    }

    .button {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      text-align: center;
    }

    .button-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }

    .button-primary:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      transform: translateY(-1px);
      color: white;
    }

    .download-links {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    .download-link {
      display: flex;
      align-items: center;
      padding: 16px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 30px;
      text-decoration: none;
      color: #495057;
      transition: all 0.2s ease;
    }

    .download-link:hover {
      background: white;
      border-color: #667eea;
      color: #667eea;
    }

    .download-icon {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      opacity: 0.7;
    }

    .loading-state {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
      flex-direction: column;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #6c757d;
      font-size: 14px;
    }

    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
    }

    .retry-button {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 30px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
    }

    .retry-button:hover {
      background: #5a67d8;
    }

    /* Account info editing styles */
    .info-row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px 0;
    }

    .info-label {
      font-weight: 600;
      color: #495057;
      min-width: 100px;
      margin-right: 12px;
    }

    .info-value {
      flex: 1;
      color: #6c757d;
    }

    .editable-field {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .edit-input {
      display: none;
      flex: 1;
      padding: 6px 12px;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 8px;
    }

    .edit-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .edit-actions {
      display: none;
      gap: 8px;
    }

    .edit-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .save-btn {
      background: #28a745;
      color: white;
    }

    .cancel-btn {
      background: #6c757d;
      color: white;
    }

    .edit-icon {
      width: 16px;
      height: 16px;
      margin-left: 8px;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s ease;
    }

    .edit-icon:hover {
      opacity: 0.8;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .header-content {
        padding: 0 16px;
      }
      
      .sign-out-btn {
        position: static;
        margin-top: 20px;
      }
      
      .main-container {
        padding: 24px 16px;
      }
      
      .card {
        padding: 24px 20px;
      }
      
      h1 {
        font-size: 24px;
      }
      
      .cards-grid {
        grid-template-columns: 1fr;
      }

      .info-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .info-label {
        min-width: auto;
        margin-right: 0;
        margin-bottom: 4px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <a href="https://www.get-empath.com">
        <img src="https://images.squarespace-cdn.com/content/v1/67b5499db71bd36240b6d2d7/994c48e7-65c4-47cc-b846-d47db72c04b9/EmpathLogo.png?format=1500w" alt="Empath" class="logo">
      </a>
      <button class="sign-out-btn" id="sign-out-btn">Sign Out</button>
    </div>
  </div>

  <div class="main-container">
    <div id="loading-state" class="loading-state">
      <div class="spinner"></div>
      <div class="loading-text">Loading your dashboard...</div>
    </div>

    <div id="dashboard-content" style="display: none;">
      <div class="welcome-section">
        <h1 id="welcome-message">Welcome back!</h1>
      </div>

      <div class="cards-grid">
        <div class="card">
          <h2>Subscription Status</h2>
          <div id="subscription-status" class="subscription-status status-free">Free Plan</div>
          <div id="subscription-details">
            <div class="plan-info">
              <div class="plan-name" id="plan-name">Free Plan</div>
              <div class="plan-details" id="plan-details">Basic features included</div>
            </div>
          </div>
          <div id="billing-actions">
            <a href="#" class="button button-primary" id="manage-billing-btn" target="_blank" style="display: none;">
              Manage Billing
            </a>
            <a href="https://auth.get-empath.com/checkout?plan=monthly" class="button button-primary" id="upgrade-btn" style="display: none;">
              Upgrade to Pro
            </a>
            <button class="retry-button" id="retry-data-btn" style="display: none;">
              Retry Loading Data
            </button>
          </div>
        </div>

        <div class="card">
          <h2>Download Empath</h2>
          <p>Get the latest version of Empath:</p>
          
          <div class="download-links">
            <a href="https://get-empath.com/download/" class="download-link">
              <svg class="download-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.71,19.5C17.88,20.74 17,21.95 15.66,21.97C14.32,22 13.89,21.18 12.37,21.18C10.84,21.18 10.37,21.95 9.1,22C7.79,22.05 6.8,20.68 5.96,19.47C4.25,17 2.94,12.45 4.7,9.39C5.57,7.87 7.13,6.91 8.82,6.88C10.1,6.86 11.32,7.75 12.11,7.75C12.89,7.75 14.37,6.68 15.92,6.84C16.57,6.87 18.39,7.1 19.56,8.82C19.47,8.88 17.39,10.1 17.41,12.63C17.44,15.65 20.06,16.66 20.09,16.67C20.06,16.74 19.67,18.11 18.71,19.5M13,3.5C13.73,2.67 14.94,2.04 15.94,2C16.07,3.17 15.6,4.35 14.9,5.19C14.21,6.04 13.07,6.7 11.95,6.61C11.8,5.46 12.36,4.26 13,3.5Z"/>
              </svg>
              macOS
            </a>
          </div>
        </div>

        <div class="card">
          <h2>Account Information</h2>
          <div id="account-details">
            <div class="info-row">
              <span class="info-label">First Name:</span>
              <div class="editable-field">
                <span class="info-value" id="first-name-display">Loading...</span>
                <input type="text" class="edit-input" id="first-name-input">
                <div class="edit-actions">
                  <button class="edit-btn save-btn" onclick="saveField('firstName')">Save</button>
                  <button class="edit-btn cancel-btn" onclick="cancelEdit('firstName')">Cancel</button>
                </div>
                <svg class="edit-icon" onclick="editField('firstName')" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04Z"/>
                </svg>
              </div>
            </div>

            <div class="info-row">
              <span class="info-label">Last Name:</span>
              <div class="editable-field">
                <span class="info-value" id="last-name-display">Loading...</span>
                <input type="text" class="edit-input" id="last-name-input">
                <div class="edit-actions">
                  <button class="edit-btn save-btn" onclick="saveField('lastName')">Save</button>
                  <button class="edit-btn cancel-btn" onclick="cancelEdit('lastName')">Cancel</button>
                </div>
                <svg class="edit-icon" onclick="editField('lastName')" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04Z"/>
                </svg>
              </div>
            </div>

            <div class="info-row">
              <span class="info-label">Email:</span>
              <span class="info-value" id="user-email">Loading...</span>
            </div>

            <div id="activation-date" style="display: none;">
              <div class="info-row">
                <span class="info-label">Active Since:</span>
                <span class="info-value" id="activation-date-text">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="error-state" class="error-message" style="display: none;">
      <div>Failed to load dashboard data.</div>
      <button class="retry-button" id="retry-btn">Retry Loading</button>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: 'AIzaSyCwpPROFnBDsX4gqdIbVsUgCZGkcvtWEKY',
      authDomain: 'auth.get-empath.com',
      projectId: 'get-empath',
      storageBucket: 'get-empath.firebasestorage.app',
      messagingSenderId: '380829207707',
      appId: '1:380829207707:web:e3b97e0bb83734ba2f4a3e',
      measurementId: 'G-W10VEF7WQL'
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();
    
    // Enable Firestore offline persistence
    try {
      firestore.enablePersistence({ synchronizeTabs: true })
        .catch((err) => {
          console.warn('Firestore persistence error:', err.message);
        });
    } catch (err) {
      console.warn('Firestore persistence setup error:', err.message);
    }

    let currentUser = null;
    let userData = null;
    let retryAttempts = 0;
    const maxRetryAttempts = 3;

    // Monitor network status (simplified)
    // Initialize after DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Dashboard is ready
    });

    // Format date helper
    function formatDate(timestamp) {
      if (!timestamp) return 'Unknown';
      
      try {
        let date;
        if (timestamp.toDate) {
          date = timestamp.toDate();
        } else if (timestamp instanceof Date) {
          date = timestamp;
        } else {
          date = new Date(timestamp);
        }
        
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch (error) {
        return 'Date error';
      }
    }

    // Show loading state
    function showLoading(message = 'Loading your dashboard...') {
      document.getElementById('loading-state').style.display = 'flex';
      document.querySelector('.loading-text').textContent = message;
      document.getElementById('dashboard-content').style.display = 'none';
      document.getElementById('error-state').style.display = 'none';
    }

    // Show dashboard content
    function showDashboard() {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'block';
      document.getElementById('error-state').style.display = 'none';
    }

    // Show error state
    function showError(message = 'Failed to load dashboard data.') {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'none';
      document.getElementById('error-state').style.display = 'block';
      document.getElementById('error-state').querySelector('div').textContent = message;
    }

    // Update subscription status display
    function updateSubscriptionStatus(status, plan) {
      const statusElement = document.getElementById('subscription-status');
      const planNameElement = document.getElementById('plan-name');
      const planDetailsElement = document.getElementById('plan-details');
      const manageBillingBtn = document.getElementById('manage-billing-btn');
      const upgradeBtn = document.getElementById('upgrade-btn');
      const retryBtn = document.getElementById('retry-data-btn');
      const activationDateDiv = document.getElementById('activation-date');

      // Reset classes and visibility
      statusElement.className = 'subscription-status';
      manageBillingBtn.style.display = 'none';
      upgradeBtn.style.display = 'none';
      retryBtn.style.display = 'none';
      activationDateDiv.style.display = 'none';

      // Handle offline state
      if (!navigator.onLine && !status) {
        statusElement.classList.add('status-offline');
        statusElement.textContent = 'Offline';
        planNameElement.textContent = 'Unable to load';
        planDetailsElement.textContent = 'Please check your internet connection';
        retryBtn.style.display = 'inline-block';
        return;
      }

      switch (status) {
        case 'free':
          statusElement.classList.add('status-free');
          statusElement.textContent = 'Free Plan';
          planNameElement.textContent = 'Free Plan';
          planDetailsElement.textContent = 'Basic features included';
          upgradeBtn.style.display = 'inline-block';
          
          // Update upgrade button with user info for checkout pre-filling
          if (currentUser && userData) {
            const upgradeParams = new URLSearchParams({
              email: userData.email || currentUser.email,
              userId: currentUser.uid,
                displayName: userData.firstName || currentUser.email.split('@')[0],
              plan: 'monthly',
              source: 'dashboard_upgrade'
            });
            upgradeBtn.href = `https://auth.get-empath.com/checkout?${upgradeParams.toString()}`;
          }
          break;

        case 'active':
          statusElement.classList.add('status-active');
          statusElement.textContent = 'Active';
          
          if (plan === 'monthly') {
            planNameElement.textContent = 'Pro Monthly';
            planDetailsElement.textContent = '$7.99/month - Full access to all features';
          } else if (plan === 'annual') {
            planNameElement.textContent = 'Pro Annual';
            planDetailsElement.textContent = '$79.99/year - Save 17% with annual billing';
          } else {
            planNameElement.textContent = 'Pro Plan';
            planDetailsElement.textContent = 'Full access to all features';
          }
          
          manageBillingBtn.style.display = 'inline-block';
          
          // Show activation date if available
          if (userData && userData.subscriptionActivatedAt) {
            activationDateDiv.style.display = 'block';
            document.getElementById('activation-date-text').textContent = formatDate(userData.subscriptionActivatedAt);
          }
          break;

        case 'pending':
          statusElement.classList.add('status-pending');
          statusElement.textContent = 'Pending';
          planNameElement.textContent = 'Subscription Pending';
          planDetailsElement.textContent = 'Your subscription is being processed';
          break;

        case 'canceled':
          statusElement.classList.add('status-canceled');
          statusElement.textContent = 'Canceled';
          planNameElement.textContent = 'Subscription Canceled';
          planDetailsElement.textContent = 'Your subscription has been canceled';
          upgradeBtn.style.display = 'inline-block';
          
          // Update upgrade button with user info for checkout pre-filling
          if (currentUser && userData) {
            const upgradeParams = new URLSearchParams({
              email: userData.email || currentUser.email,
              userId: currentUser.uid,
                displayName: userData.firstName || currentUser.email.split('@')[0],
              plan: 'monthly',
              source: 'dashboard_reactivate'
            });
            upgradeBtn.href = `https://auth.get-empath.com/checkout?${upgradeParams.toString()}`;
          }
          break;

        default:
          statusElement.classList.add('status-free');
          statusElement.textContent = 'Unknown Status';
          planNameElement.textContent = 'Unknown Plan';
          planDetailsElement.textContent = 'Please contact support if this persists';
          retryBtn.style.display = 'inline-block';
      }
    }

    // Inline editing functions
    function editField(fieldName) {
      const display = document.getElementById(`${fieldName.toLowerCase().replace('name', '-name')}-display`);
      const input = document.getElementById(`${fieldName.toLowerCase().replace('name', '-name')}-input`);
      const actions = input.parentNode.querySelector('.edit-actions');
      const icon = input.parentNode.querySelector('.edit-icon');

      display.style.display = 'none';
      input.style.display = 'block';
      actions.style.display = 'flex';
      icon.style.display = 'none';
      
      input.value = display.textContent;
      input.focus();
    }

    function cancelEdit(fieldName) {
      const display = document.getElementById(`${fieldName.toLowerCase().replace('name', '-name')}-display`);
      const input = document.getElementById(`${fieldName.toLowerCase().replace('name', '-name')}-input`);
      const actions = input.parentNode.querySelector('.edit-actions');
      const icon = input.parentNode.querySelector('.edit-icon');

      display.style.display = 'block';
      input.style.display = 'none';
      actions.style.display = 'none';
      icon.style.display = 'block';
    }

    async function saveField(fieldName) {
      const display = document.getElementById(`${fieldName.toLowerCase().replace('name', '-name')}-display`);
      const input = document.getElementById(`${fieldName.toLowerCase().replace('name', '-name')}-input`);
      const actions = input.parentNode.querySelector('.edit-actions');
      const icon = input.parentNode.querySelector('.edit-icon');

      const newValue = input.value.trim();
      if (!newValue) {
        alert('Field cannot be empty');
        return;
      }

      try {
        // Update Firestore
        await firestore.collection('users').doc(currentUser.uid).update({
        [fieldName]: newValue
        });

        // Update local data and UI
        userData[fieldName] = newValue;
        if (fieldName === 'firstName' || fieldName === 'lastName') {
          userData.displayName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
          document.getElementById('welcome-message').textContent = `Welcome back, ${userData.firstName || 'there'}!`;
        }

        display.textContent = newValue;
        cancelEdit(fieldName);

      } catch (error) {
        console.error('Error updating field:', error);
        alert('Failed to update information. Please try again.');
      }
    }

    // Load user data from Firestore with retry logic
    async function loadUserData(userId, isRetry = false) {
  const attemptNumber = retryAttempts + 1;
  
  console.log('=== Loading user data ===');
  console.log('User ID:', userId);
  console.log('Is retry:', isRetry);
  console.log('Retry attempt:', attemptNumber);
  
  if (isRetry) {
    showLoading('Retrying data load...');
    
    // On retry, refresh auth token and test connection
    const tokenRefreshed = await refreshAuthToken();
    console.log('Auth token refresh result:', tokenRefreshed);
    
    const connectionOk = await testFirestoreConnection();
    console.log('Firestore connection test result:', connectionOk);
    
    if (!connectionOk) {
      throw new Error('Firestore connection test failed');
    }
  }

  try {
    if (!auth.currentUser) {
      throw new Error('User not authenticated');
    }
    
    console.log('Making Firestore request...');
    
    // Try alternative method first on retries
    let userDoc;
    if (isRetry && retryAttempts > 1) {
      console.log('Using alternative Firestore access method...');
      userDoc = await loadUserDataAlternative(userId);
    } else {
      // Standard method with shorter timeout on retries
      const timeoutDuration = isRetry ? 5000 : 10000;
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error(`Firestore request timeout after ${timeoutDuration/1000} seconds`)), timeoutDuration);
      });

      const userDocPromise = firestore.collection('users').doc(userId).get();
      userDoc = await Promise.race([userDocPromise, timeoutPromise]);
    }
    
    console.log('Firestore response received, document exists:', userDoc.exists);
    
    if (userDoc.exists) {
      userData = userDoc.data();
      console.log('Document data loaded successfully');
      
      // Update UI
      const displayName = userData.firstName || 'there';
      document.getElementById('welcome-message').textContent = `Welcome back, ${displayName}!`;
      
      const email = userData.email || currentUser.email;
      document.getElementById('user-email').textContent = email;
      document.getElementById('first-name-display').textContent = userData.firstName || 'Not set';
      document.getElementById('last-name-display').textContent = userData.lastName || 'Not set';
      
      const status = userData.subscriptionStatus || 'free';
      const plan = userData.plan || 'free';
      updateSubscriptionStatus(status, plan);
      
      if (userData.fastspringCustomerId && status === 'active') {
        const manageBillingBtn = document.getElementById('manage-billing-btn');
        manageBillingBtn.href = 'https://empath.onfastspring.com/account';
      }
      
      retryAttempts = 0;
      
    } else {
      console.log('Document does not exist, creating new one...');
      
      const basicUserData = {
        email: currentUser.email,
        firstName: currentUser.displayName ? currentUser.displayName.split(' ')[0] : '',
        lastName: currentUser.displayName ? currentUser.displayName.split(' ').slice(1).join(' ') : '',
        subscriptionStatus: 'free',
        plan: 'free',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdVia: 'dashboard_timeout_recovery',
        lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Try to create with shorter timeout
      const createPromise = firestore.collection('users').doc(userId).set(basicUserData, { merge: true });
      const createTimeout = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Document creation timeout')), 5000);
      });
      
      await Promise.race([createPromise, createTimeout]);
      userData = basicUserData;
      
      document.getElementById('welcome-message').textContent = `Welcome, ${userData.firstName || 'there'}!`;
      document.getElementById('user-email').textContent = currentUser.email;
      document.getElementById('first-name-display').textContent = userData.firstName || 'Not set';
      document.getElementById('last-name-display').textContent = userData.lastName || 'Not set';
      updateSubscriptionStatus('free', 'free');
    }
    
    showDashboard();
    console.log('=== User data loading completed successfully ===');
    
  } catch (error) {
    console.error('=== Error loading user data ===');
    console.error('Error:', error.message);
    
    retryAttempts++;
    
    if (error.message.includes('timeout')) {
      if (retryAttempts < maxRetryAttempts) {
        console.log(`Retrying after timeout (attempt ${retryAttempts + 1}/${maxRetryAttempts})`);
        // Exponential backoff: 3s, 6s, 12s
        const delay = Math.min(3000 * Math.pow(2, retryAttempts - 1), 12000);
        setTimeout(() => {
          loadUserData(userId, true);
        }, delay);
      } else {
        // Final fallback: create minimal dashboard
        console.log('Max retries reached, showing fallback dashboard');
        showMinimalDashboard();
      }
    } else {
      showError(`Failed to load account data: ${error.message}`);
    }
  }
}

function showMinimalDashboard() {
  console.log('Showing minimal dashboard due to persistent connection issues');
  
  // Set basic user info from auth
  document.getElementById('welcome-message').textContent = 'Welcome back!';
  document.getElementById('user-email').textContent = currentUser.email;
  document.getElementById('first-name-display').textContent = 'Connection issue';
  document.getElementById('last-name-display').textContent = 'Connection issue';
  
  // Show free plan status
  updateSubscriptionStatus('free', 'free');
  
  // Show dashboard with a connection warning
  showDashboard();
  
  // Add a notice about the connection issue
  const warningDiv = document.createElement('div');
  warningDiv.className = 'error-message';
  warningDiv.innerHTML = `
    <div>Connection issue detected. Some features may not work properly.</div>
    <button class="retry-button" onclick="location.reload()">Refresh Page</button>
  `;
  document.querySelector('.main-container').insertBefore(warningDiv, document.querySelector('.cards-grid'));
}

async function refreshAuthToken() {
  try {
    console.log('Refreshing auth token...');
    const user = auth.currentUser;
    if (user) {
      await user.getIdToken(true); // Force refresh
      console.log('Auth token refreshed successfully');
      return true;
    }
  } catch (error) {
    console.error('Failed to refresh auth token:', error);
    return false;
  }
  return false;
}

// Test Firestore connectivity with a simple operation
async function testFirestoreConnection() {
  try {
    console.log('Testing Firestore connection...');
    const testDoc = await firestore.collection('_test').doc('connection').get();
    console.log('Firestore connection test successful');
    return true;
  } catch (error) {
    console.error('Firestore connection test failed:', error);
    return false;
  }
}

// Alternative document access method
async function loadUserDataAlternative(userId) {
  try {
    console.log('Trying alternative Firestore access method...');
    
    // Try with explicit source options
    const userDoc = await firestore.collection('users').doc(userId).get({
      source: 'server' // Force server read, bypass cache
    });
    
    console.log('Alternative method successful, document exists:', userDoc.exists);
    return userDoc;
  } catch (error) {
    console.error('Alternative method failed:', error);
    throw error;
  }
}

    // Manual retry function
    function retryLoadUserData() {
      if (currentUser) {
        retryAttempts = 0;
        loadUserData(currentUser.uid, true);
      }
    }

    // Authentication state handler
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        retryAttempts = 0;
        
        // Load user data from Firestore
        await loadUserData(user.uid);
        
      } else {
        window.location.href = '/login';
      }
    });

    // Sign out handler
    document.getElementById('sign-out-btn').addEventListener('click', async () => {
      try {
        await auth.signOut();
        window.location.href = '/login';
      } catch (error) {
        console.error('Sign out error:', error);
        alert('Failed to sign out. Please try again.');
      }
    });

    // Retry button handlers
    document.getElementById('retry-btn').addEventListener('click', () => {
      retryLoadUserData();
    });

    document.getElementById('retry-data-btn').addEventListener('click', () => {
      retryLoadUserData();
    });

    // Initialize dashboard
    showLoading();

    // Listen for real-time updates to user document
    let userDocListener = null;

    function setupUserDocumentListener(userId) {
      if (userDocListener) {
        userDocListener(); // Unsubscribe previous listener
      }

      userDocListener = firestore.collection('users').doc(userId).onSnapshot((doc) => {
        if (doc.exists) {
          const updatedData = doc.data();
          
          // Check if subscription status changed
          if (userData && updatedData.subscriptionStatus !== userData.subscriptionStatus) {
            userData = updatedData;
            
            const status = userData.subscriptionStatus || 'free';
            const plan = userData.plan || 'free';
            updateSubscriptionStatus(status, plan);
            
            // Update billing management link if needed
            if (userData.fastspringCustomerId && status === 'active') {
              const manageBillingBtn = document.getElementById('manage-billing-btn');
              const billingUrl = `https://empath.onfastspring.com/account/authenticate?email=${encodeURIComponent(userData.email)}`;
              manageBillingBtn.href = billingUrl;
            }
          } else if (userData) {
            // Update other fields that might have changed
            userData = updatedData;
            document.getElementById('first-name-display').textContent = userData.firstName || 'Not set';
            document.getElementById('last-name-display').textContent = userData.lastName || 'Not set';
            
            if (userData.firstName) {
              document.getElementById('welcome-message').textContent = `Welcome back, ${userData.firstName}!`;
            }
          }
        }
      }, (error) => {
        console.error('Real-time listener error:', error);
      });
    }

    // Setup listener when user is authenticated
    auth.onAuthStateChanged((user) => {
      if (user) {
        setupUserDocumentListener(user.uid);
      } else if (userDocListener) {
        userDocListener(); // Cleanup listener
        userDocListener = null;
      }
    });

    // Cleanup listener when page unloads
    window.addEventListener('beforeunload', () => {
      if (userDocListener) {
        userDocListener();
      }
    });

    // Network status change handlers (simplified)
    window.addEventListener('online', () => {
      // Retry loading data if we're in an error state and have a user
      if (currentUser && (document.getElementById('error-state').style.display !== 'none' || retryAttempts > 0)) {
        retryAttempts = 0;
        setTimeout(() => {
          loadUserData(currentUser.uid, true);
        }, 1000);
      }
    });

    window.addEventListener('offline', () => {
      // Handle offline state
    });

    // Error reporting for debugging
    window.addEventListener('error', (event) => {
      console.error(`Global error: ${event.message} at ${event.filename}:${event.lineno}`);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error(`Unhandled promise rejection: ${event.reason}`);
    });
  </script>
</body>
</html>